{% extends 'base.html' %}

{% block title %}
  XXXè²é‡è§€å¯Ÿ
{% endblock %}

{% block extra_css %}
  <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
  <div class="container">
    <div class="row">
      <div class="col-lg-12 mb-3">
        <h1>XXXè²é‡è§€å¯Ÿ</h1>
        <p>ä½ é—œå¿ƒçš„äººäº‹ç‰©</p>
      </div>

      <div class="col-12 mb-4">
        <div class="card">
          <div class="card-header">
            <h3 class="h6 text-uppercase mb-0">è³‡æ–™é€±æœŸ:è³‡æ–™æˆªæ­¢æ™‚é–“ 2025-04-08</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h3>ç¶²è·¯è²é‡</h3>
                <p>æ–°èå ±å°æœ‰å¤šå°‘ç¯‡æ–°èæåŠé€™çµ„é—œéµå­—ï¼Œè²é‡è¶Šé«˜è¡¨ç¤ºèƒ½è¦‹åº¦è¶Šé«˜ã€‚</p>
                <p>ç¸½ç¯‡æ•¸: æœ‰å¤šå°‘ç¯‡æ–°èæåˆ°ï¼›ç¸½æ¬¡æ•¸: åœ¨ç›¸é—œæ–°èä¸­è¢«æåˆ°å¤šå°‘æ¬¡</p>

                <form id="keywordForm" class="mb-3">
                  <div class="d-flex align-items-center gap-2">
                    <input type="text" class="form-control me-2" id="keywordInput" placeholder="è«‹è¼¸å…¥é—œéµå­—" style="max-width: 300px;" />
                    <button class="btn btn-primary" type="button">ç¢ºèª</button>
                  </div>
                </form>

                <div id="keywordResult" class="mt-3 text-primary fw-bold fs-4"></div>
              </div>

              <div class="col-md-6">
                <div id="share_of_voice" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è²é‡åœ–è¡¨ -->
      <div class="col-lg-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h3 class="h6 text-uppercase mb-0">è²é‡åˆ†å¸ƒæƒ…æ³</h3>
          </div>
          <div class="card-body">
            <h3>ä¾æ“šæ–°èé¡åˆ¥çµ±è¨ˆç¶²è·¯è²é‡</h3>
            <p>åœ¨å“ªä¸€é¡åˆ¥çš„æ–°èä¸­è¢«å ±å°æœ€å¤šç¯‡ï¼Ÿ</p>
            <hr />
            <canvas id="bar_chart"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h3 class="h6 text-uppercase mb-0">è²é‡è®ŠåŒ–</h3>
          </div>
          <div class="card-body">
            <h3>ä¾æ“šæ™‚é–“é¡¯ç¤ºè²é‡çš„è®ŠåŒ–</h3>
            <p>åœ¨å“ªå€‹æ™‚é–“é»è¢«æ–°èå ±å°æœ€å¤šï¼Ÿ</p>
            <hr />
            <canvas id="line_chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>

  <script>
    let barChart, lineChart
    
    $(document).ready(function () {
      console.log('âœ… jQuery å°±ç·’')
    
      // æŒ‰ä¸‹æŸ¥è©¢æŒ‰éˆ•æ™‚
      $('#keywordForm button').on('click', function () {
        const keyword = $('#keywordInput').val().trim()
        const resultDiv = $('#keywordResult')
        resultDiv.text('')
        $('#share_of_voice').empty()
    
        if (!keyword) {
          alert('è«‹è¼¸å…¥é—œéµå­—ï¼')
    
          // ğŸ§½ æ¸…ç©ºåœ–è¡¨
          if (barChart) {
            barChart.destroy()
            barChart = null
          }
          if (lineChart) {
            lineChart.destroy()
            lineChart = null
          }
    
          return
        }
    
        if (!keyword) {
          alert('è«‹è¼¸å…¥é—œéµå­—ï¼')
          return
        }
    
        const csrftoken = getCookie('csrftoken')
        $.ajax({
          type: 'POST',
          url: "{% url 'app_top_voice:api_cate_topvoice' %}",
          data: {
            keyword: keyword,
            csrfmiddlewaretoken: csrftoken
          },
          success: function (data) {
            if (data.status === 'success') {
              resultDiv.text('"' + keyword + '" å‡ºç¾åœ¨ ' + data.count + ' ç¯‡æ–°èä¸­ï¼Œå…±è¢«æåŠ ' + data.frequency + ' æ¬¡')
    
              var html = ''
              if (data.photo_link && data.link) {
                html += '<img src="' + data.photo_link + '" class="img-fluid rounded mb-2" alt="æ–°èåœ–ç‰‡" style="max-height: 200px; width: auto;">'
                html += '<p><a href="' + data.link + '" target="_blank" class="btn btn-outline-primary btn-sm">ğŸ”— é»æˆ‘çœ‹è©²ç¯‡æ–°è</a></p>'
              } else {
                html = '<p class="text-muted">ç„¡å¯ç”¨åœ–ç‰‡æˆ–é€£çµ</p>'
              }
    
              $('#share_of_voice').html(html)
              updateCharts(keyword)
            } else {
              resultDiv.text('æŸ¥è©¢éŒ¯èª¤ï¼š' + data.message)
            }
          },
          error: function (xhr, status, error) {
            resultDiv.text(`è«‹æ±‚å¤±æ•—ï¼š${error}`)
          }
        })
      })
    
      // AJAX è«‹æ±‚å¾Œç«¯åœ–è¡¨è³‡æ–™
      function updateCharts(keyword = '') {
        const csrftoken = getCookie('csrftoken')
        $.ajax({
          type: 'POST',
          url: "{% url 'app_top_voice:api_news_volume_data' %}",
          data: {
            keyword: keyword,
            csrfmiddlewaretoken: csrftoken
          },
          success: function (data) {
            if (data.status === 'success') {
              renderCategoryChart(data.category_count)
              renderDateChart(data.date_count)
            } else {
              console.error('åœ–è¡¨è³‡æ–™éŒ¯èª¤ï¼š', data.message)
            }
          }
        })
      }
    
      // ç¹ªè£½åˆ†é¡é•·æ¢åœ–
      function renderCategoryChart(categoryData) {
        if (barChart) barChart.destroy()
        const ctx = document.getElementById('bar_chart').getContext('2d')
        barChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(categoryData),
            datasets: [
              {
                label: 'æ–°èæ•¸é‡',
                data: Object.values(categoryData),
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            title: {
              display: true,
              text: 'ä¾æ–°èé¡åˆ¥çµ±è¨ˆ'
            },
            scales: {
              yAxes: [
                {
                  ticks: { beginAtZero: true }
                }
              ]
            }
          }
        })
      }
    
      // ç¹ªè£½æ™‚é–“æŠ˜ç·šåœ–
      function renderDateChart(dateData) {
        if (lineChart) lineChart.destroy()
        const ctx = document.getElementById('line_chart').getContext('2d')
        lineChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: Object.keys(dateData),
            datasets: [
              {
                label: 'æ¯æ—¥æ–°èæ•¸',
                data: Object.values(dateData),
                fill: false,
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 2,
                lineTension: 0.1
              }
            ]
          },
          options: {
            responsive: true,
            title: {
              display: true,
              text: 'è²é‡æ™‚é–“è®ŠåŒ–'
            },
            scales: {
              xAxes: [
                {
                  type: 'time',
                  time: {
                    unit: 'day',
                    tooltipFormat: 'YYYY-MM-DD',
                    displayFormats: {
                      day: 'YYYY-MM-DD'
                    }
                  }
                }
              ]
            }
          }
        })
      }
    
      // CSRF å–å¾—å‡½æ•¸
      function getCookie(name) {
        let cookieValue = null
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';')
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim()
            if (cookie.substring(0, name.length + 1) === name + '=') {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
              break
            }
          }
        }
        return cookieValue
      }
    })
  </script>
{% endblock %}
